---
- name: Rolling Kubernetes Node Maintenance
  hosts: rpicluster
  serial: 1
  gather_facts: yes
  become: yes

  vars:
    kubectl_context: "default"
    drain_timeout: "300s"
    node_ready_retries: 30
    node_ready_delay: 10

  tasks:
    - name: Get node name
      command: hostname
      register: node_hostname
      changed_when: false

    - name: Cordon node
      delegate_to: localhost
      command: k3s kubectl cordon {{ node_hostname.stdout }}
      changed_when: true

    - name: Drain node
      delegate_to: localhost
      command: >
        k3s kubectl drain {{ node_hostname.stdout }}
        --ignore-daemonsets
        --delete-emptydir-data

    - name: Reboot node
      reboot:
        reboot_timeout: 600
        msg: "Rebooting node for maintenance"

    - name: Wait for node to be Ready
      delegate_to: localhost
      command: k3s kubectl get node {{ node_hostname.stdout }} -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}'
      register: node_status
      until: node_status.stdout == "True"
      retries: "{{ node_ready_retries }}"
      delay: "{{ node_ready_delay }}"
      changed_when: false

    - name: Uncordon node
      delegate_to: localhost
      command: k3s kubectl uncordon {{ node_hostname.stdout }}
      changed_when: true
