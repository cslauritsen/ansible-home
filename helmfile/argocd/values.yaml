## ArgoCD configuration
## Ref: https://github.com/argoproj/argo-helm/tree/main/charts/argo-cd

global:
  domain: argocd.home.planetlauritsen.com

## Server configuration
server:
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 128Mi
  ingress:
    enabled: true
    ingressClassName: nginx
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-dns
      nginx.ingress.kubernetes.io/ssl-passthrough: "false"
      nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
      nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
      # OAuth2 proxy authentication
      disablednginx.ingress.kubernetes.io/auth-url: "https://oauth2-proxy.home.planetlauritsen.com/oauth2/auth"
      disablednginx.ingress.kubernetes.io/auth-signin: "https://oauth2-proxy.home.planetlauritsen.com/oauth2/start?rd=https://$host$request_uri"
      # Pass authentication headers to ArgoCD
      disablednginx.ingress.kubernetes.io/auth-response-headers: "X-Auth-Request-User,X-Auth-Request-Email"
    hosts:
      - argocd.home.planetlauritsen.com
    tls:
      - secretName: wildcard-home-planetlauritsen-tls # pragma: allowlist secret
        hosts:
          - argocd.home.planetlauritsen.com
          - oauth2-proxy.home.planetlauritsen.com
    https: true

  # Additional configurations for server
  extraArgs:
    - --insecure  # Terminate TLS at ingress level

dex:
  enabled: true

## Redis configuration - use default settings for ARM64 compatibility
redis:
  enabled: true

## ApplicationSet controller
applicationSet:
  enabled: true

## Notifications controller
notifications:
  enabled: true

## Config management plugins
configs:
  # Repository credentials and settings
  repositories: {}

  # General ArgoCD configuration
  cm:
    dex.config: |
        connectors:
          - type: google
            id: google
            name: Google
            config:
                issuer: https://accounts.google.com
                clientID: 87763540819-b9p1bf6du800qu9apa46ai8gthei5hjd.apps.googleusercontent.com
                clientSecret: $dex.google.clientSecret
                userIDKey: email
                orgs:
                - name: planetlauritsen
    # Server URL
    url: https://argocd.home.planetlauritsen.com

    # Enable exec provider for repo credentials (if needed)
    exec.enabled: "true"

    # Timeout settings
    timeout.reconciliation: 180s

    # Enable anonymous users - these are authenticated by oauth2-proxy
    # ArgoCD will trust that nginx has already authenticated the user
    users.anonymous.enabled: "false"

  # ArgoCD server parameters
  params:
    # Enable reading username from headers
    # nginx passes X-Auth-Request-Email from oauth2-proxy
    server.rbac.log.enforce.enable: "true"

  # RBAC Configuration - Define roles and permissions
  rbac:
    # Grant admin to all oauth2-proxy authenticated users
    # Since oauth2-proxy already restricts to allowed-emails.txt, this is safe
    policy.default: role:readonly

    # RBAC policies - grant admin to anonymous users (authenticated by oauth2-proxy)
    policy.csv: |
      # grant admin to specific google users
      g, csl4jc@gmail.com, role:admin
      g, 106840556952436428759, role:admin
      
      # Grant full admin permissions to anonymous users (oauth2-proxy authenticated)
      p, role:admin, applications, *, */*, allow
      p, role:admin, clusters, *, *, allow
      p, role:admin, repositories, *, *, allow
      p, role:admin, projects, *, *, allow
      p, role:admin, accounts, *, *, allow
      p, role:admin, certificates, *, *, allow
      p, role:admin, gpgkeys, *, *, allow
      g, role:admin, role:admin
      # p, role:anonymous, projects, *, *, allow
      # p, role:anonymous, accounts, *, *, allow
      # p, role:anonymous, certificates, *, *, allow
      # p, role:anonymous, gpgkeys, *, *, allow
      # g, role:anonymous, role:admin
      
      # g, your-email@example.com, role:admin
      # g, another-admin@example.com, role:admin
      # And remove the role:anonymous admin grant

## Resource limits for ARM64 Raspberry Pi cluster
controller:
  resources:
    limits:
      cpu: 1000m
      memory: 1Gi
    requests:
      cpu: 250m
      memory: 512Mi

repoServer:
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 256Mi

